{% extends "base.html" %}

{% block title %}Bulk Actions - Incident Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="content-card">
                <div class="content-header">
                    <h4 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Bulk Actions
                    </h4>
                </div>
                <div class="content-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Select Action:</h6>
                            <select class="form-select" id="bulkAction">
                                <option value="">Choose Action</option>
                                {% if session.role in ['admin', 'manager'] %}
                                <option value="assign">Bulk Assign</option>
                                <option value="status">Change Status</option>
                                <option value="priority">Change Priority</option>
                                {% endif %}
                                {% if session.role == 'admin' %}
                                <option value="delete">Bulk Delete</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-6" id="actionOptions" style="display:none">
                            <!-- Dynamic options based on selected action -->
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Assigned To</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for incident in incidents %}
                                <tr>
                                    <td><input type="checkbox" class="incident-checkbox" value="{{ incident.id }}"></td>
                                    <td>#{{ incident.id }}</td>
                                    <td>{{ incident.title }}</td>
                                    <td><span class="badge severity-{{ incident.priority }}">{{ incident.priority.title() }}</span></td>
                                    <td><span class="badge status-{{ incident.status }}">{{ incident.status.replace('_', ' ').title() }}</span></td>
                                    <td>{{ incident.assignee.username if incident.assignee else 'Unassigned' }}</td>
                                    <td>{{ incident.created_at.strftime('%m/%d/%Y') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back
                        </a>
                        <button class="btn btn-primary" onclick="executeBulkAction()" id="executeBtn" disabled>
                            <i class="fas fa-play me-1"></i>Execute Action
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.incident-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateExecuteButton();
});

document.querySelectorAll('.incident-checkbox').forEach(cb => {
    cb.addEventListener('change', updateExecuteButton);
});

document.getElementById('bulkAction').addEventListener('change', function() {
    const action = this.value;
    const optionsDiv = document.getElementById('actionOptions');
    
    if (action) {
        optionsDiv.style.display = 'block';
        let html = '<h6>Options:</h6>';
        
        switch(action) {
            case 'assign':
                html += '<select class="form-select" id="assignTo"><option value="">Select Engineer</option>';
                {% for user in users %}
                {% if user.role == 'engineer' %}
                html += '<option value="{{ user.id }}">{{ user.username }}</option>';
                {% endif %}
                {% endfor %}
                html += '</select>';
                break;
            case 'status':
                html += '<select class="form-select" id="newStatus">';
                html += '<option value="open">Open</option>';
                html += '<option value="in_progress">In Progress</option>';
                html += '<option value="resolved">Resolved</option>';
                html += '<option value="closed">Closed</option>';
                html += '</select>';
                break;
            case 'priority':
                html += '<select class="form-select" id="newPriority">';
                html += '<option value="low">Low</option>';
                html += '<option value="medium">Medium</option>';
                html += '<option value="high">High</option>';
                html += '<option value="critical">Critical</option>';
                html += '</select>';
                break;
        }
        
        optionsDiv.innerHTML = html;
    } else {
        optionsDiv.style.display = 'none';
    }
    updateExecuteButton();
});

function updateExecuteButton() {
    const selected = document.querySelectorAll('.incident-checkbox:checked').length;
    const action = document.getElementById('bulkAction').value;
    document.getElementById('executeBtn').disabled = !(selected > 0 && action);
}

function executeBulkAction() {
    const selected = Array.from(document.querySelectorAll('.incident-checkbox:checked')).map(cb => cb.value);
    const action = document.getElementById('bulkAction').value;
    
    if (selected.length === 0 || !action) return;
    
    let data = { incident_ids: selected, action: action };
    
    switch(action) {
        case 'assign':
            data.user_id = document.getElementById('assignTo').value;
            break;
        case 'status':
            data.status = document.getElementById('newStatus').value;
            break;
        case 'priority':
            data.priority = document.getElementById('newPriority').value;
            break;
    }
    
    if (confirm(`Execute ${action} on ${selected.length} incidents?`)) {
        fetch('/api/bulk-actions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Action failed');
            }
        });
    }
}
</script>
{% endblock %}